# WP Mini Program API

为微信小程序提供 WordPress REST API 扩展插件。

## 插件简介

WP Mini Program API 是一个专为微信小程序设计的 WordPress 插件，用于扩展 WordPress 原生 REST API，为微信小程序提供完整的后端接口支持。该插件无需依赖第三方插件，采用模块化设计，便于维护和功能扩展。

## 主要功能

1. **文章管理**

   - 获取文章列表（支持分页）
   - 获取文章详情
   - 按分类筛选文章
2. **分类管理**

   - 获取分类列表
   - 查看分类下的文章
3. **评论系统**

   - 获取文章评论（支持分页）
   - 提交评论（支持匿名评论）
   - 后台控制是否允许小程序端评论
4. **页面内容**

   - 获取页面列表
   - 获取页面详情
5. **缩略图支持**

   - 自动获取文章特色图像
   - 可设置默认缩略图
6. **服务器端缓存**

   - 自动缓存API响应，减轻服务器压力
   - 可配置缓存时长
   - 智能缓存清除机制
   - 支持手动清除所有缓存
7. **小程序端缓存**

   - 小程序端实现数据缓存，进一步提升用户体验
   - 缓存时长与后台设置保持一致
   - 下拉刷新时自动清除缓存

## 缓存功能说明

本插件实现了服务器端和小程序端双重缓存功能，可以显著减少数据库查询次数，提高API响应速度，减轻服务器压力。

### 服务器端缓存

#### 缓存特性

1. **智能缓存**

   - 文章列表和详情缓存
   - 分类列表和分类下文章缓存
   - 页面列表和详情缓存
   - 评论列表缓存
   - 网站信息缓存
2. **缓存管理**

   - 自动缓存清除：当文章、页面、评论等内容更新时，自动清除相关缓存
   - 手动缓存清除：可在插件设置中手动清除所有缓存
   - 缓存状态标识：API响应头包含X-WP-Cache标识（HIT表示缓存命中，MISS表示缓存未命中）
3. **可配置性**

   - 可在后台设置中启用/禁用缓存功能
   - 可自定义缓存时长（默认300秒）

### 小程序端缓存

#### 缓存特性

1. **智能缓存**

   - 文章列表和详情缓存
   - 分类列表缓存
   - 页面内容缓存
   - 评论列表缓存
   - 网站信息缓存
2. **缓存管理**

   - 自动过期机制：根据后台设置的缓存时长自动过期
   - 下拉刷新清除：下拉刷新时自动清除相关缓存
   - 智能更新：内容更新时自动清除相关缓存
3. **与后台同步**

   - 缓存时长与后台设置保持一致
   - 实时获取后台缓存配置

### 缓存配置

在WordPress后台的"设置"->"微信小程序"页面中，可以找到缓存相关配置：

1. **启用API缓存**：勾选以启用缓存功能
2. **缓存时长**：设置缓存的有效时间（秒），默认为300秒（5分钟）

不同数据类型的默认缓存时长：

- 文章列表：5分钟
- 文章详情：2分钟
- 分类列表：30分钟
- 评论列表：1分钟
- 页面内容：5分钟
- 网站信息：1小时

## 配置文件管理

小程序使用统一的配置文件管理API地址和其他设置：

- 配置文件位置：`pages/article/config.js`（文章相关页面）
- 配置内容：包含API基础URL等设置
- 引用方式：各页面通过相对路径引用同目录下的配置文件

配置文件示例：

```
const config = {
  // WordPress网站的API域名
  apiBaseUrl: 'https://wp.lxzt.fun/wp-json/wp-mini-program/v1'
}

module.exports = config
```

## 模块路径引用规范

为确保小程序正确加载所有模块，需要遵循以下引用规范：

1. **相对路径引用**：

   - 所有模块引用必须使用相对路径
   - 禁止使用绝对路径（如`/utils/config.js`）
   - 正确的引用方式：`./config.js`（引用同目录下的文件）
2. **路径一致性**：

   - 每个目录下的页面引用同目录下的配置文件
   - 不同目录需要各自的配置文件副本
3. **模块位置**：

   - 公共模块放置在各自页面目录下
   - 避免跨目录引用导致的路径问题
4. **常见错误避免**：

   - 避免使用错误的路径层级（如`../../utils/config.js`）
   - 确保文件名大小写正确
   - 验证模块文件确实存在于指定位置

### 调试建议

1. **启用WordPress调试模式**

   - 在wp-config.php中设置`define('WP_DEBUG', true);`
   - 设置`define('WP_DEBUG_LOG', true);`将错误记录到日志文件
   - 设置`define('WP_DEBUG_DISPLAY', false);`避免在生产环境显示错误
2. **查看错误日志**

   - 检查WordPress的debug.log文件（通常位于wp-content目录）
   - 查看服务器错误日志
   - 使用浏览器开发者工具查看网络请求和响应
3. **测试API端点**

   - 使用浏览器或Postman直接访问API端点
   - 检查返回的HTTP状态码和响应内容
   - 确认请求参数是否正确
4. **小程序调试**

   - 使用微信开发者工具查看控制台错误信息
   - 检查模块引用路径是否正确
   - 确认所有依赖文件都存在且可访问

## 安装说明

1. 下载插件压缩包
2. 解压后上传到 WordPress 的 `/wp-content/plugins/` 目录
3. 在 WordPress 后台激活插件
4. 在"设置"->"微信小程序"中配置相关选项

## API 接口文档

### 基础路径

所有API接口的基础路径为：`/wp-json/wp-mini-program/v1`

### 文章相关接口

- `GET /posts` - 获取文章列表
- `GET /posts/{id}` - 获取文章详情

### 分类相关接口

- `GET /categories` - 获取分类列表
- `GET /categories/{id}/posts` - 获取分类下的文章

### 评论相关接口

- `GET /comments` - 获取评论列表
- `POST /comments` - 提交评论

### 页面相关接口

- `GET /pages` - 获取页面列表
- `GET /pages/{id}` - 获取页面详情

### 搜索相关接口

- `GET /search` - 搜索文章

### 点赞相关接口

- `POST /likes` - 点赞文章
- `DELETE /likes` - 取消点赞

### 收藏相关接口

- `POST /favorites` - 收藏文章
- `DELETE /favorites` - 取消收藏
- `GET /favorites` - 获取收藏列表

### 网站信息接口

- `GET /site-info` - 获取网站信息和缓存配置

## 使用说明

1. 激活插件后，在WordPress后台的"设置"菜单中会出现"微信小程序"选项
2. 根据需要配置相关选项
3. 在小程序端使用提供的API接口

## 开发者说明

插件采用面向对象的设计模式，各功能模块独立，便于扩展和维护：

- `class-posts-controller.php` - 文章控制器
- `class-categories-controller.php` - 分类控制器
- `class-comments-controller.php` - 评论控制器
- `class-pages-controller.php` - 页面控制器
- `class-search-controller.php` - 搜索控制器
- `class-likes-controller.php` - 点赞控制器
- `class-favorites-controller.php` - 收藏控制器
- `class-site-info-controller.php` - 网站信息控制器
- `class-settings.php` - 设置管理
- `class-cache-manager.php` - 缓存管理
